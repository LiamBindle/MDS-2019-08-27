<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>

		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/simple.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/github-gist.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h2 style="margin: 0; text-align: left;">A Deep Dive into CMake (for Fortran)</h2>
					<hr>
					<h4 style="margin: 0;">MDS</h4>
					<h4 style="margin: 0;">2019-08-27</h4>
					<h4 style="margin: 0;">Liam Bindle</h4>
				</section>
				<section>
					<div style="text-align: left;">
						<h3 style="margin: 0;">Overview</h3>
						<hr>
						<ol>
							<li>Overview of Modern CMake
								<ul>
									<li>A Basic CMake Project</li>
									<li>Targets and properties</li>
									<li>A Bigger CMake Project</li>
									<li>Pros and cons of CMake</li>
								</ul>
							</li>
							<li>GEOS-Chem's CMakeLists
								<ul>
									<li>Principles</li>
									<li>Dependency structure</li>
									<li>How it all works</li>
								</ul>
							</li>
						</ol>
					</div>
				</section>
				<section>
					<h2>A Basic CMake Project</h2>
				</section>
				<!-- Slide 1 -->
				<section>
					<section>
						<h3 style="margin: 0;">A Basic CMake Project</h3>
						<h5 style="margin: 0">Overview</h5>
						<hr style="margin-bottom: 20px">
						<div class="container" style="width: 80%">
							<div class="inline-wide" style="text-align: left; margin-right: 100px;">
								<ul>
									<li>Example of a simple CMake project</li>
									<li>Its an F90 module that wraps the original bhmie code
										<ul>
											<li>Original bhmie code: <a href="http://scatterlib.wikidot.com/mie">scatterlib/bhmie</a></li>
											<li><code>bhmie_mod.f90 </code> is the module</li>
											<li><code>bhmie_smod.f </code> is the original bhmie code as a submodule</li>
											<li><code>callbhmie.f </code> is the example program</li>
										</ul>
									</li>
								</ul>
							</div>
							<div class="file-tree" style="margin: 0;"> 
								<h3>Directory structure</h3>
								<code>bhmie-f/<br>
								├── bhmie_mod.f90<br>
								├── bhmie_smod.f<br>
								├── callbhmie.f<br>
								├── CMakeLists.txt<br>
								└── README<br></code>
							</div>
						</div>
					</section>
				</section>

				<!-- Slide 1 -->
				<section>
					<h3 style="margin: 0;">A Basic CMake Project</h3>
					<h5 style="margin: 0">Conceptually we need to...</h5>
					<hr style="margin-bottom: 40px">
					<div class="container" style="width: 80%">
						<div class="inline-wide" style="text-align: left; margin-right: 80px;">
							<ol>
								<li>Build a static library called <code>libbhmie.a</code> from
									<ul>
										<li><code>bhmie_mod.f90</code></li>
										<li><code>bhmie_smod.f</code></li>
									</ul>
								</li>
								<li>Build an executable from "callbhmie.f"
									<ul><li>Link <code>libbhmie.a</code></li></ul>
								</li>
							</ol>
						</div>
						<div class="file-tree" style="margin: 0;"> 
							<h3>Directory structure</h3>
							<code>bhmie-f/<br>
								├── bhmie_mod.f90<br>
								├── bhmie_smod.f<br>
								├── callbhmie.f<br>
								├── CMakeLists.txt<br>
								└── README<br></code>
						</div>
					</div>
				</section>

				<!-- Slide 1 -->
				<section data-transition="none-out">
					<h3 style="margin: 0;">A Basic CMake Project</h3>
					<h5 style="margin: 0">bhmie-f/CMakeLists.txt</h5>
					<hr>
					<div class="container">
						<div class="file-tree"> 
							<code><strong>bhmie-f/</strong><br>
								├── bhmie_mod.f90<br>
								├── bhmie_smod.f<br>
								├── callbhmie.f<br>
								├── <strong>CMakeLists.txt</strong><br>
								└── README<br>
							</code>
						</div>
						<div class="inline-wide"><pre><code class="cmake" data-trim data-noescape data-line-numbers>
							cmake_minimum_required(VERSION 3.5)
							project(bhmie VERSION 1.0.0 LANGUAGES Fortran)


							# Add a static library called libbhmie.a
							add_library(bhmie STATIC
								bhmie_smod.f
								bhmie_mod.f90
							)


							# Add an executable called callbhmie
							add_executable(callbhmie
								callbhmie.f
							)
							# Specify that callbhmie links to libbhmie.a
							target_link_libraries(callbhmie
								bhmie 
							)
						</code></pre></div>
					</div>
				</section>

				<section data-transition="none-in none-out">
					<h3 style="margin: 0;">A Basic CMake Project</h3>
					<h5 style="margin: 0">bhmie-f/CMakeLists.txt</h5>
					<hr>
					<div class="container">
						<div class="file-tree"> 
							<code><strong>bhmie-f/</strong><br>
								├── bhmie_mod.f90<br>
								├── bhmie_smod.f<br>
								├── callbhmie.f<br>
								├── <strong>CMakeLists.txt</strong><br>
								└── README<br>
							</code>
						</div>
						<div class="inline-wide"><pre><code class="cmake" data-trim data-noescape data-line-numbers="1-2">
							cmake_minimum_required(VERSION 3.5)
							project(bhmie VERSION 1.0.0 LANGUAGES Fortran)


							# Add a static library called libbhmie.a
							add_library(bhmie STATIC
								bhmie_smod.f
								bhmie_mod.f90
							)


							# Add an executable called callbhmie
							add_executable(callbhmie
								callbhmie.f
							)
							# Specify that callbhmie links to libbhmie.a
							target_link_libraries(callbhmie
								bhmie 
							)
						</code></pre></div>
					</div>
				</section>

				<!-- Slide 2 -->
				<section data-transition="none-in none-out">
					<section>
						<h3 style="margin: 0;">A Basic CMake Project</h3>
						<h5 style="margin: 0">bhmie-f/CMakeLists.txt</h5>
						<hr>
						<div class="container">
								<div class="file-tree"> 
									<code><strong>bhmie-f/</strong><br>
										├── bhmie_mod.f90<br>
										├── bhmie_smod.f<br>
										├── callbhmie.f<br>
										├── <strong>CMakeLists.txt</strong><br>
										└── README<br>
									</code>
								</div>
								<div class="inline-wide"><pre><code class="cmake" data-trim data-noescape data-line-numbers="5-9">
									cmake_minimum_required(VERSION 3.5)
									project(bhmie VERSION 1.0.0 LANGUAGES Fortran)
		
		
									# Add a static library called libbhmie.a
									add_library(bhmie STATIC
										bhmie_smod.f
										bhmie_mod.f90
									)
		
		
									# Add an executable called callbhmie
									add_executable(callbhmie
										callbhmie.f
									)
									# Specify that callbhmie links to libbhmie.a
									target_link_libraries(callbhmie
										bhmie 
									)
								</code></pre></div>
							</div>
					</section>
					<section>
						<img class="plain" data-src="images/add_library.png">
					</section>
				</section>

				<!-- Slide 3 -->
				<section data-transition="none-in none-out">
					<section>
						<h3 style="margin: 0;">A Basic CMake Project</h3>
						<h5 style="margin: 0">bhmie-f/CMakeLists.txt</h5>
						<hr>
						<div class="container">
								<div class="file-tree"> 
									<code><strong>bhmie-f/</strong><br>
										├── bhmie_mod.f90<br>
										├── bhmie_smod.f<br>
										├── callbhmie.f<br>
										├── <strong>CMakeLists.txt</strong><br>
										└── README<br>
									</code>
								</div>
								<div class="inline-wide"><pre><code class="cmake" data-trim data-noescape data-line-numbers="13-15">
									cmake_minimum_required(VERSION 3.5)
									project(bhmie VERSION 1.0.0 LANGUAGES Fortran)
		
		
									# Add a static library called libbhmie.a
									add_library(bhmie STATIC
										bhmie_smod.f
										bhmie_mod.f90
									)
		
		
									# Add an executable called callbhmie
									add_executable(callbhmie
										callbhmie.f
									)
									# Specify that callbhmie links to libbhmie.a
									target_link_libraries(callbhmie
										bhmie 
									)
								</code></pre></div>
							</div>
					</section>
					<section>
						<img class="plain" data-src="images/add_executable.png">
					</section>
				</section>

				<!-- Slide 4 -->
				<section data-transition="none-in none-out">
					<section>
						<h3 style="margin: 0;">A Basic CMake Project</h3>
						<h5 style="margin: 0">bhmie-f/CMakeLists.txt</h5>
						<hr>
						<div class="container">
								<div class="file-tree"> 
									<code><strong>bhmie-f/</strong><br>
										├── bhmie_mod.f90<br>
										├── bhmie_smod.f<br>
										├── callbhmie.f<br>
										├── <strong>CMakeLists.txt</strong><br>
										└── README<br>
									</code>
								</div>
								<div class="inline-wide"><pre><code class="cmake" data-trim data-noescape data-line-numbers="16-19">
									cmake_minimum_required(VERSION 3.5)
									project(bhmie VERSION 1.0.0 LANGUAGES Fortran)
		
		
									# Add a static library called libbhmie.a
									add_library(bhmie STATIC
										bhmie_smod.f
										bhmie_mod.f90
									)
		
		
									# Add an executable called callbhmie
									add_executable(callbhmie
										callbhmie.f
									)
									# Specify that callbhmie links to libbhmie.a
									target_link_libraries(callbhmie
										bhmie 
									)
								</code></pre></div>
							</div>
					</section>
					<section>
						<img class="plain" data-src="images/target_link_libraries-1.png">
					</section>
				</section>

				<!-- Slide 5 -->
				<section data-transition="none-in none-out">
					<section>
						<h3 style="margin: 0;">A Basic CMake Project</h3>
						<h5 style="margin: 0">Questions?</h5>
						<hr>
						<div class="container">
							<div class="file-tree"> 
								<code><strong>bhmie-f/</strong><br>
									├── bhmie_mod.f90<br>
									├── bhmie_smod.f<br>
									├── callbhmie.f<br>
									├── <strong>CMakeLists.txt</strong><br>
									└── README<br>
								</code>
							</div>
							<div class="inline-wide"><pre><code class="cmake" data-trim data-noescape data-line-numbers>
								cmake_minimum_required(VERSION 3.5)
								project(bhmie VERSION 1.0.0 LANGUAGES Fortran)
	
	
								# Add a static library called libbhmie.a
								add_library(bhmie STATIC
									bhmie_smod.f
									bhmie_mod.f90
								)
	
	
								# Add an executable called callbhmie
								add_executable(callbhmie
									callbhmie.f
								)
								# Specify that callbhmie links to libbhmie.a
								target_link_libraries(callbhmie
									bhmie 
								)
							</code></pre></div>
						</div>
					</section>
				</section>

				<!-- Slide 5 -->
				<section data-markdown="target_and_properties.md"
						 data-separator="^\n\n\n"
						 data-separator-vertical="^\n\n"
						 data-separator-notes="^Note:"
					  	 data-charset="iso-8859-15">
				</section>

				<section>
					<h2>A Bigger CMake Project</h2>
				</section>

				<!-- Slide 5 -->
				<section>
						<!-- add_subdirectory and find_package, special variables, then what CMake is good at/not good at ...consistency-->
						<h3 style="margin: 0;">A Bigger CMake Project</h3>
						<h5 style="margin: 0">Overview</h5>
						<hr>
						<div class="container" style="width: 90%">
							<div class="inline-wide" style="text-align: left; margin-right: 100px;">
								
									<ul>
										<li>Example aerosol microphysics library called "amp"</li>
										<li>Builds on the bhmie-f project</li>
										<li><code>amp_*.f90 </code>  are modules with microphysics routines
											<ul><li>These require LAPACK</li></ul>
										</li>
										<li><code>cloud_parcel.f90</code> is a parcel model
											<ul><li>Uses kracken for command line argument parsing</li></ul>
										</li>
									</ul>
							</div>
							<div class="file-tree" style="margin: 0;"> 
								<h3>Directory structure</h3>
								<code>
								amp/<br>
								├── kracken/ ⇒ <a href="https://github.com/mlt/kracken">github.com/mlt/kracken</a><br>
								├── bhmie-f/<br>
								│   ├── bhmie_mod.f90<br>
								│   ├── bhmie_smod.f<br>
								│   ├── callbhmie.f<br>
								│   ├── CMakeLists.txt<br>
								│   └── README<br>
								├── amp_chemistry.f90<br>
								├── amp_dynamics.f90<br>
								├── amp_optical.f90<br>
								├── amp_utils.f90<br>
								├── CMakeLists.txt<br>
								└── cloud_parcel.f90<br>
								</code>
							</div>
						</div>
				</section>

				<!-- Slide 5 -->
				<section>
					<!-- add_subdirectory and find_package, special variables, then what CMake is good at/not good at ...consistency-->
					<h3 style="margin: 0;">A Bigger CMake Project</h3>
					<h5 style="margin: 0">Conceptually we need to...</h5>
					<hr>
						<div class="container" style="width: 90%">
							<div class="inline-wide" style="text-align: left; margin-right: 100px;">
								<ol>
									<li class="fragment fade-in-then-semi-out">Build <code>libamp.a</code>
										<ul>
											<li>Source files: <code>amp_*.f90</code></li>
											<li>Build <code>libbhmie.a</code></li>
											<li>Put <code>libbhmie.a</code> into <code>libamp.a</code></li>
											<li>Find LAPACK installation</li>
											<li>Include module directories for bhmie and LAPACK</li>
										</ul>
									</li>
									<li class="fragment fade-in">Build <code>cloud_parcel.f90</code>
										<ul>
											
											<li>Build <code>libkracken.a</code></li>
											<li>Link <code>libamp.a</code> and <code>libkracken.a</code> and their dependencies
												<ul><li>Link "libblas.so" (since LAPACK is used by amp)</li></ul>
											</li>
											<li>Include kracken's module directories for amp and kracken</li>
										</ul>
									</li>
								</ol>
							</div>
							<div class="file-tree" style="margin: 0;"> 
								<h3>Directory structure</h3>
								<code>
								amp/<br>
								├── kracken/ ⇒ <a href="https://github.com/mlt/kracken">github.com/mlt/kracken</a><br>
								├── bhmie-f/<br>
								│   ├── bhmie_mod.f90<br>
								│   ├── bhmie_smod.f<br>
								│   ├── callbhmie.f<br>
								│   ├── CMakeLists.txt<br>
								│   └── README<br>
								├── amp_chemistry.f90<br>
								├── amp_dynamics.f90<br>
								├── amp_optical.f90<br>
								├── amp_utils.f90<br>
								├── CMakeLists.txt<br>
								└── cloud_parcel.f90<br>
								</code>
							</div>
						</div>
				</section>

				<!-- Slide 2 -->
				<section data-transition="none-in none-out">
					<section>
						<h3 style="margin: 0;">A Bigger CMake Project</h3>
						<h5 style="margin: 0">amp/CMakeLists</h5>
						<hr>
						<div style="position: relative;">
							<div>
								<pre><code class="cmake" data-trim data-noescape data-line-numbers>
									cmake_minimum_required(VERSION 3.5)
									project(amp VERSION 0.0.0 LANGUAGES Fortran)
									set(CMAKE_POLICY_DEFAULT_CMP0048 NEW)
									
									set(CMAKE_Fortran_MODULE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/modules)
									
									add_subdirectory(bhmie-f)
									add_subdirectory(kracken)

									find_package(LAPACK REQUIRED)
									
									add_library(amp
										amp_chemistry.f90 amp_dynamics.f90 amp_optical.f90 amp_utils.f90
									)
									target_link_libraries(amp
										PUBLIC bhmie ${LAPACK_LIBRARIES}
									)
									target_include_directories(amp
										PUBLIC ${CMAKE_Fortran_MODULE_DIRECTORY}
									)

									add_executable(cloud_parcel cloud_parcel.f90)
									target_link_libraries(cloud_parcel amp kracken)
								</code></pre>
							</div>
							<div class="file-tree"> 
								<small style="position: absolute; top: 0; right: 0; background-color: white;"><code>
								<strong>amp/</strong><br>
								├── kracken/<br>
								├── bhmie-f/<br>
								├── amp_chemistry.f90<br>
								├── amp_dynamics.f90<br>
								├── amp_optical.f90<br>
								├── amp_utils.f90<br>
								├── <strong>CMakeLists.txt</strong><br>
								└── cloud_parcel.f90<br>
								</code></small>
							</div>
						</div>
					</section>
				</section>

				<!-- Slide 2 -->
				<section data-transition="none-in none-out">
					<section>
						<h3 style="margin: 0;">A Bigger CMake Project</h3>
						<h5 style="margin: 0">amp/CMakeLists</h5>
						<hr>
						<div style="position: relative;">
							<div>
								<pre><code class="cmake" data-trim data-noescape data-line-numbers="3,5">
									cmake_minimum_required(VERSION 3.5)
									project(amp VERSION 0.0.0 LANGUAGES Fortran)
									set(CMAKE_POLICY_DEFAULT_CMP0048 NEW)
									
									set(CMAKE_Fortran_MODULE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/modules)
									
									add_subdirectory(bhmie-f)
									add_subdirectory(kracken)

									find_package(LAPACK REQUIRED)
									
									add_library(amp
										amp_chemistry.f90 amp_dynamics.f90 amp_optical.f90 amp_utils.f90
									)
									target_link_libraries(amp
										PUBLIC bhmie ${LAPACK_LIBRARIES}
									)
									target_include_directories(amp
										PUBLIC ${CMAKE_Fortran_MODULE_DIRECTORY}
									)

									add_executable(cloud_parcel cloud_parcel.f90)
									target_link_libraries(cloud_parcel amp kracken)
								</code></pre>
							</div>
							<div class="file-tree"> 
								<small style="position: absolute; top: 0; right: 0; background-color: white;"><code>
								<strong>amp/</strong><br>
								├── kracken/<br>
								├── bhmie-f/<br>
								├── amp_chemistry.f90<br>
								├── amp_dynamics.f90<br>
								├── amp_optical.f90<br>
								├── amp_utils.f90<br>
								├── <strong>CMakeLists.txt</strong><br>
								└── cloud_parcel.f90<br>
								</code></small>
							</div>
						</div>
					</section>
					<section>
						<img class="plain" data-src="images/set.png">
					</section>
				</section>

				<!-- Slide 2 -->
				<section data-transition="none-in none-out">
					<section>
						<h3 style="margin: 0;">A Bigger CMake Project</h3>
						<h5 style="margin: 0">amp/CMakeLists</h5>
						<hr>
						<div style="position: relative;">
							<div>
								<pre><code class="cmake" data-trim data-noescape data-line-numbers="1-3">
									cmake_minimum_required(VERSION 3.5)
									project(amp VERSION 0.0.0 LANGUAGES Fortran)
									set(CMAKE_POLICY_DEFAULT_CMP0048 NEW)
									
									set(CMAKE_Fortran_MODULE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/modules)
									
									add_subdirectory(bhmie-f)
									add_subdirectory(kracken)

									find_package(LAPACK REQUIRED)
									
									add_library(amp
										amp_chemistry.f90 amp_dynamics.f90 amp_optical.f90 amp_utils.f90
									)
									target_link_libraries(amp
										PUBLIC bhmie ${LAPACK_LIBRARIES}
									)
									target_include_directories(amp
										PUBLIC ${CMAKE_Fortran_MODULE_DIRECTORY}
									)

									add_executable(cloud_parcel cloud_parcel.f90)
									target_link_libraries(cloud_parcel amp kracken)
								</code></pre>
							</div>
							<div class="file-tree"> 
								<small style="position: absolute; top: 0; right: 0; background-color: white;"><code>
								<strong>amp/</strong><br>
								├── kracken/<br>
								├── bhmie-f/<br>
								├── amp_chemistry.f90<br>
								├── amp_dynamics.f90<br>
								├── amp_optical.f90<br>
								├── amp_utils.f90<br>
								├── <strong>CMakeLists.txt</strong><br>
								└── cloud_parcel.f90<br>
								</code></small>
							</div>
						</div>
					</section>
					<section>
						<img class="plain" data-src="images/cmp0048.png">
					</section>
				</section>

				<!-- Slide 2 -->
				<section data-transition="none-in none-out">
					<section>
						<h3 style="margin: 0;">A Bigger CMake Project</h3>
						<h5 style="margin: 0">amp/CMakeLists</h5>
						<hr>
						<div style="position: relative;">
							<div>
								<pre><code class="cmake" data-trim data-noescape data-line-numbers="5">
									cmake_minimum_required(VERSION 3.5)
									project(amp VERSION 0.0.0 LANGUAGES Fortran)
									set(CMAKE_POLICY_DEFAULT_CMP0048 NEW)
									
									set(CMAKE_Fortran_MODULE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/modules)
									
									add_subdirectory(bhmie-f)
									add_subdirectory(kracken)

									find_package(LAPACK REQUIRED)
									
									add_library(amp
										amp_chemistry.f90 amp_dynamics.f90 amp_optical.f90 amp_utils.f90
									)
									target_link_libraries(amp
										PUBLIC bhmie ${LAPACK_LIBRARIES}
									)
									target_include_directories(amp
										PUBLIC ${CMAKE_Fortran_MODULE_DIRECTORY}
									)

									add_executable(cloud_parcel cloud_parcel.f90)
									target_link_libraries(cloud_parcel amp kracken)
								</code></pre>
							</div>
							<div class="file-tree"> 
								<small style="position: absolute; top: 0; right: 0; background-color: white;"><code>
								<strong>amp/</strong><br>
								├── kracken/<br>
								├── bhmie-f/<br>
								├── amp_chemistry.f90<br>
								├── amp_dynamics.f90<br>
								├── amp_optical.f90<br>
								├── amp_utils.f90<br>
								├── <strong>CMakeLists.txt</strong><br>
								└── cloud_parcel.f90<br>
								</code></small>
							</div>
						</div>
					</section>
					<section>
						<img class="plain" data-src="images/fortran_module_directory.png">
					</section>
					<section>
							<img class="plain" data-src="images/current_binary_dir.png">
						</section>
				</section>

				<!-- Slide 2 -->
				<section data-transition="none-in none-out">
					<section>
						<h3 style="margin: 0;">A Bigger CMake Project</h3>
						<h5 style="margin: 0">amp/CMakeLists</h5>
						<hr>
						<div style="position: relative;">
							<div>
								<pre><code class="cmake" data-trim data-noescape data-line-numbers="7-8">
									cmake_minimum_required(VERSION 3.5)
									project(amp VERSION 0.0.0 LANGUAGES Fortran)
									set(CMAKE_POLICY_DEFAULT_CMP0048 NEW)
									
									set(CMAKE_Fortran_MODULE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/modules)
									
									add_subdirectory(bhmie-f)
									add_subdirectory(kracken)

									find_package(LAPACK REQUIRED)
									
									add_library(amp
										amp_chemistry.f90 amp_dynamics.f90 amp_optical.f90 amp_utils.f90
									)
									target_link_libraries(amp
										PUBLIC bhmie ${LAPACK_LIBRARIES}
									)
									target_include_directories(amp
										PUBLIC ${CMAKE_Fortran_MODULE_DIRECTORY}
									)

									add_executable(cloud_parcel cloud_parcel.f90)
									target_link_libraries(cloud_parcel amp kracken)
								</code></pre>
							</div>
							<div class="file-tree"> 
								<small style="position: absolute; top: 0; right: 0; background-color: white;"><code>
								<strong>amp/</strong><br>
								├── kracken/<br>
								├── bhmie-f/<br>
								├── amp_chemistry.f90<br>
								├── amp_dynamics.f90<br>
								├── amp_optical.f90<br>
								├── amp_utils.f90<br>
								├── <strong>CMakeLists.txt</strong><br>
								└── cloud_parcel.f90<br>
								</code></small>
							</div>
						</div>
					</section>
					<section>
						<img class="plain" data-src="images/add_subdirectory.png">
					</section>
				</section>

				<!-- Slide 2 -->
				<section data-transition="none-in none-out">
					<section>
						<h3 style="margin: 0;">A Bigger CMake Project</h3>
						<h5 style="margin: 0">amp/CMakeLists</h5>
						<hr>
						<div style="position: relative;">
							<div>
								<pre><code class="cmake" data-trim data-noescape data-line-numbers="10">
									cmake_minimum_required(VERSION 3.5)
									project(amp VERSION 0.0.0 LANGUAGES Fortran)
									set(CMAKE_POLICY_DEFAULT_CMP0048 NEW)
									
									set(CMAKE_Fortran_MODULE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/modules)
									
									add_subdirectory(bhmie-f)
									add_subdirectory(kracken)

									find_package(LAPACK REQUIRED)
									
									add_library(amp
										amp_chemistry.f90 amp_dynamics.f90 amp_optical.f90 amp_utils.f90
									)
									target_link_libraries(amp
										PUBLIC bhmie ${LAPACK_LIBRARIES}
									)
									target_include_directories(amp
										PUBLIC ${CMAKE_Fortran_MODULE_DIRECTORY}
									)

									add_executable(cloud_parcel cloud_parcel.f90)
									target_link_libraries(cloud_parcel amp kracken)
								</code></pre>
							</div>
							<div class="file-tree"> 
								<small style="position: absolute; top: 0; right: 0; background-color: white;"><code>
								<strong>amp/</strong><br>
								├── kracken/<br>
								├── bhmie-f/<br>
								├── amp_chemistry.f90<br>
								├── amp_dynamics.f90<br>
								├── amp_optical.f90<br>
								├── amp_utils.f90<br>
								├── <strong>CMakeLists.txt</strong><br>
								└── cloud_parcel.f90<br>
								</code></small>
							</div>
						</div>
					</section>
					<section>
						<img class="plain" data-src="images/find_package.png">
					</section>
					<section>
						<img class="plain" data-src="images/find_lapack.png" style="max-height: 500px;">
					</section>
				</section>

				<!-- Slide 2 -->
				<section data-transition="none-in none-out">
					<section>
						<h3 style="margin: 0;">A Bigger CMake Project</h3>
						<h5 style="margin: 0">amp/CMakeLists</h5>
						<hr>
						<div style="position: relative;">
							<div>
								<pre><code class="cmake" data-trim data-noescape data-line-numbers="12-20">
									cmake_minimum_required(VERSION 3.5)
									project(amp VERSION 0.0.0 LANGUAGES Fortran)
									set(CMAKE_POLICY_DEFAULT_CMP0048 NEW)
									
									set(CMAKE_Fortran_MODULE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/modules)
									
									add_subdirectory(bhmie-f)
									add_subdirectory(kracken)

									find_package(LAPACK REQUIRED)
									
									add_library(amp
										amp_chemistry.f90 amp_dynamics.f90 amp_optical.f90 amp_utils.f90
									)
									target_link_libraries(amp
										PUBLIC bhmie ${LAPACK_LIBRARIES}
									)
									target_include_directories(amp
										PUBLIC ${CMAKE_Fortran_MODULE_DIRECTORY}
									)

									add_executable(cloud_parcel cloud_parcel.f90)
									target_link_libraries(cloud_parcel amp kracken)
								</code></pre>
							</div>
							<div class="file-tree"> 
								<small style="position: absolute; top: 0; right: 0; background-color: white;"><code>
								<strong>amp/</strong><br>
								├── kracken/<br>
								├── bhmie-f/<br>
								├── amp_chemistry.f90<br>
								├── amp_dynamics.f90<br>
								├── amp_optical.f90<br>
								├── amp_utils.f90<br>
								├── <strong>CMakeLists.txt</strong><br>
								└── cloud_parcel.f90<br>
								</code></small>
							</div>
						</div>
					</section>
					<section>
						<img class="plain" data-src="images/add_library.png">
					</section>
					<section>
						<img class="plain" data-src="images/target_link_libraries-2.png">
					</section>
					<section>
						<img class="plain" data-src="images/target_include_directories.png">
					</section>
				</section>

				<!-- Slide 2 -->
				<section data-transition="none-in none-out">
					<section>
						<h3 style="margin: 0;">A Bigger CMake Project</h3>
						<h5 style="margin: 0">amp/CMakeLists</h5>
						<hr>
						<div style="position: relative;">
							<div>
								<pre><code class="cmake" data-trim data-noescape data-line-numbers="22-23">
									cmake_minimum_required(VERSION 3.5)
									project(amp VERSION 0.0.0 LANGUAGES Fortran)
									set(CMAKE_POLICY_DEFAULT_CMP0048 NEW)
									
									set(CMAKE_Fortran_MODULE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/modules)
									
									add_subdirectory(bhmie-f)
									add_subdirectory(kracken)

									find_package(LAPACK REQUIRED)
									
									add_library(amp
										amp_chemistry.f90 amp_dynamics.f90 amp_optical.f90 amp_utils.f90
									)
									target_link_libraries(amp
										PUBLIC bhmie ${LAPACK_LIBRARIES}
									)
									target_include_directories(amp
										PUBLIC ${CMAKE_Fortran_MODULE_DIRECTORY}
									)

									add_executable(cloud_parcel cloud_parcel.f90)
									target_link_libraries(cloud_parcel amp kracken)
								</code></pre>
							</div>
							<div class="file-tree"> 
								<small style="position: absolute; top: 0; right: 0; background-color: white;"><code>
								<strong>amp/</strong><br>
								├── kracken/<br>
								├── bhmie-f/<br>
								├── amp_chemistry.f90<br>
								├── amp_dynamics.f90<br>
								├── amp_optical.f90<br>
								├── amp_utils.f90<br>
								├── <strong>CMakeLists.txt</strong><br>
								└── cloud_parcel.f90<br>
								</code></small>
							</div>
						</div>
					</section>
					<section>
						<img class="plain" data-src="images/add_executable.png">
					</section>
					<section>
						<img class="plain" data-src="images/target_link_libraries-2.png">
					</section>
				</section>

				<section data-transition="none-in none-out">
					<h3 style="margin: 0;">A Bigger CMake Project</h3>
					<h5 style="margin: 0">Questions?</h5>
					<hr>
					<div style="position: relative;">
						<div>
							<pre><code class="cmake" data-trim data-noescape data-line-numbers>
								cmake_minimum_required(VERSION 3.5)
								project(amp VERSION 0.0.0 LANGUAGES Fortran)
								set(CMAKE_POLICY_DEFAULT_CMP0048 NEW)
								
								set(CMAKE_Fortran_MODULE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/modules)
								
								add_subdirectory(bhmie-f)
								add_subdirectory(kracken)

								find_package(LAPACK REQUIRED)
								
								add_library(amp
									amp_chemistry.f90 amp_dynamics.f90 amp_optical.f90 amp_utils.f90
								)
								target_link_libraries(amp
									PUBLIC bhmie ${LAPACK_LIBRARIES}
								)
								target_include_directories(amp
									PUBLIC ${CMAKE_Fortran_MODULE_DIRECTORY}
								)

								add_executable(cloud_parcel cloud_parcel.f90)
								target_link_libraries(cloud_parcel amp kracken)
							</code></pre>
						</div>
						<div class="file-tree"> 
							<small style="position: absolute; top: 0; right: 0; background-color: white;"><code>
							<strong>amp/</strong><br>
							├── kracken/<br>
							├── bhmie-f/<br>
							├── amp_chemistry.f90<br>
							├── amp_dynamics.f90<br>
							├── amp_optical.f90<br>
							├── amp_utils.f90<br>
							├── <strong>CMakeLists.txt</strong><br>
							└── cloud_parcel.f90<br>
							</code></small>
						</div>
					</div>
				</section>

				<section data-markdown="gets_you.md"
						 data-separator="^\n\n\n"
						 data-separator-vertical="^\n\n"
						 data-separator-notes="^Note:"
					  	 data-charset="iso-8859-15">
				</section>
				<section>
					<div style="text-align: left;">
						<h3 style="margin: 0;">Some good references</h3>
						<hr style="margin-bottom: 30px;">
						<ul>
							<li><a href="https://pabloariasal.github.io/2018/02/19/its-time-to-do-cmake-right/">It's Time To Do CMake Right</a>, by Pablo Arias</li>
							<li><a href="https://www.youtube.com/watch?v=rLopVhns4Zs&feature=youtu.be">Effective CMake</a>, by Daniel Pfeifer</li>
							<li><a href="https://cliutils.gitlab.io/modern-cmake/">Modern CMake</a>, by Henry Schreiner and others</li>
							<li>The <a href="https://cmake.org/cmake/help/latest/index.html">Official CMake Documentation</a></li>
						</ul>
					</div>
				</section>	
				<section>
					<h2>Questions?</h2>
				</section>	
				<section>
					<h2>GEOS-Chem's CMakeLists</h2>
				</section>	
				<section>
					<div style="text-align: left;">
						<h3 style="margin: 0;">GEOS-Chem's CMakeLists</h3>
						<h5 style="margin: 0">Principles</h5>
						<hr>
						<ul>
							<li>Heavily reliant on modern CMake principles</li>
							<li><code>BaseTarget</code> is used to pass properties up to GEOS-Chem's targets</li>
							<li>All GEOS-Chem target's publicly link <code>BaseTarget</code></li>
							<li><code>geos</code> is the only target included in "all"</li>
							<li>What gets built depends on <code>geos</code>'s dependencies</li>
						</ul>
					</div>
				</section>	
				<section>
					<h3 style="margin: 0;">GEOS-Chem's CMakeLists</h3>
					<h5 style="margin: 0">Dependency structure</h5>
					<hr>
					<img class="plain" data-src="images/GC.svg" style="height: 500px; width: 500px;">
				</section>
				<section>
					<h3 style="margin: 0;">GEOS-Chem's CMakeLists</h3>
					<h5 style="margin: 0">Conceptually we need to...</h5>
					<hr>
						<div class="container" style="width: 90%">
							<div class="inline-wide" style="text-align: left; margin-right: 100px;">
								<ol>
									<li class="fragment fade-in">Configure <code>BaseTarget</code> based on the simulation
										<ul>
											<li>Sets the compiler definitions and options for all our targets</li>
											<li>Triggers <code>geos</code> to link NetCDF-Fortran and its dependencies</li>
										</ul>
									</li>
									<li class="fragment fade-in">Add all our subdirectories</li>
									<li class="fragment fade-in">Every subdirectory adds <strong>all</strong> its targets
										<ul>
											<li>Proper links are crucial</li>
										</ul>
									</li>
									<li class="fragment fade-in">Set conditional links based on the simulation and the build configuration
										<ul>
											<li><code>KPPFirstPass_${MECH}</code>, and <code>KPP_${MECH}</code></li>
											<li><code>APM</code>, <code>Hg</code>, and <code>GeosRad</code></li>
										</ul>
									</li>
								</ol>
							</div>
							<div class="file-tree" style="margin: 0;"> 
								<small><code>
									geos-chem/<br>
									├── APM/<br>
									├── bin/<br>
									├── CMakeScripts/<br>
									├── doc/<br>
									├── GeosCore/<br>
									├── GeosRad/<br>
									├── GeosUtil/<br>
									├── GTMM/<br>
									├── Headers/<br>
									├── help/<br>
									├── HEMCO/<br>
									├── History/<br>
									├── ISORROPIA/<br>
									├── KPP/<br>
									├── lib/<br>
									├── mod/<br>
									├── NcdfUtil/<br>
									├── ObsPack/<br>
									├── PKUCPL/<br>
									├── AUTHORS.txt<br>
									├── CMakeLists.txt<br>
									├── LICENSE.txt<br>
									├── Makefile<br>
									├── Makefile_header.mk<br>
									├── README.md<br>
									└── REVISIONS<br>
								</code></small>
							</div>
						</div>
				</section>
				<section data-transition="none-out">
					<div style="text-align: left;">
						<h3 style="margin: 0;">GEOS-Chem's CMakeLists</h3>
						<h5 style="margin: 0">The flow of geos-chem/CMakeLists.txt</h5>
						<hr>
						<ol>
							<li>Set up the project
								<ul>
									<li>Declare the project</li>
									<li>Set policies</li>
									<li>Import helper functions</li>
									<li>Create <code>BaseTarget</code></li>
									<li>Set basic <code>BaseTarget</code> properties (e.g. module directory)</li>
								</ul>
							</li>
							<li>Configure <code>BaseTarget</code>
								<ul>
									<li>Find the run directory</li>
									<li>Call <code>${RUNDIR}/getRunInfo</code></li>
									<li>Set compiler definitions and options</li>
								</ul>
							<li>Add subdirectories</li>
						</ol>
					</div>
				</section>
				<section data-transition="none-in none-out">
					<section>
						<div style="text-align: left;">
							<h3 style="margin: 0;">GEOS-Chem's CMakeLists</h3>
							<h5 style="margin: 0">Setting up the project</h5>
							<hr>
							<ol>
								<li>Set up the project
									<ul>
										<li>Declare the project</li>
										<li>Set policies</li>
										<li>Import helper functions</li>
										<li>Create <code>BaseTarget</code></li>
										<li>Set basic <code>BaseTarget</code> properties (e.g. module directory)</li>
									</ul>
								</li>
								<li style="opacity: 0.5;">Configure <code>BaseTarget</code>
									<ul>
										<li>Find the run directory</li>
										<li>Call <code>${RUNDIR}/getRunInfo</code></li>
										<li>Set compiler definitions and options</li>
									</ul>
								<li style="opacity: 0.5;">Add subdirectories</li>
							</ol>
						</div>
					</section>
					<section>
						<h3 style="margin: 0;">geos-chem/CMakeLists.txt</h3>
						<hr>
						<pre><code class="cmake" data-trim data-noescape data-line-numbers="1-67">
							cmake_minimum_required(VERSION 3.5)
							project(GEOS_Chem VERSION 12.4.0 LANGUAGES Fortran)
							
							# Set policies
							cmake_policy(SET CMP0054 NEW)
							cmake_policy(SET CMP0057 NEW)
							if(POLICY CMP0074)
								cmake_policy(SET CMP0074 NEW)
							endif()
							if(POLICY CMP0079)
								cmake_policy(SET CMP0079 NEW)
							endif()
							
							# Add CMakeScripts/ to the module path and import helper functions
							list(INSERT CMAKE_MODULE_PATH 0 ${CMAKE_SOURCE_DIR}/CMakeScripts)
							include(GC-Helpers)
							
							# Declare the BaseTarget. All GEOS-Chem targets depend on BaseTarget.
							# This is used to control the compiler options and definitions for GEOS-Chem
							# targets (via inheritance). 
							add_library(BaseTarget INTERFACE)
							
							# Put all of GEOS-Chem's mod files in a subdirectory of the build directory called mod
							set(CMAKE_Fortran_MODULE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/mod)
							target_include_directories(BaseTarget 
								INTERFACE ${CMAKE_CURRENT_BINARY_DIR}/mod
							)
							
							# Link NetCDF-F to BaseTarget
							find_package(NetCDF REQUIRED)
							target_link_libraries(BaseTarget INTERFACE NetCDF-F)
							
							# Use the NC_HAS_COMPRESSION definition if nf_def_var_deflate is in netcdf.inc
							if(EXISTS ${NETCDF_F77_INCLUDE_DIR}/netcdf.inc)
								file(READ ${NETCDF_F77_INCLUDE_DIR}/netcdf.inc NCINC)
								if("${NCINC}" MATCHES ".*nf_def_var_deflate.*")
									target_compile_definitions(BaseTarget INTERFACE "NC_HAS_COMPRESSION")
								endif()
							endif()
							
							# Print a description of the source code repo's version
							get_repo_version(GC_REPO_VERSION ${CMAKE_SOURCE_DIR})
							message(STATUS "GEOS-Chem version: ${GC_REPO_VERSION}")
							
							if(NOT GC_EXTERNAL_CONFIG)
								# This conditional block configures the GEOS-Chem build for GEOS-Chem 
								# Classic. As mentioned above, it sets GCCLASSIC_EXE_TARGETS, RRTMG, GTMM
								# TOMAS, MECH, and GCHP, and it configures the BaseTarget.
							
								# Set CMAKE_BUILD_TYPE to Release by default
								if(NOT CMAKE_BUILD_TYPE)
									set(CMAKE_BUILD_TYPE "Release" 
										CACHE STRING
										"Choose the type of build, options are: Debug Release."
										FORCE
									)
								endif()
								
								# Display CMAKE_PREFIX_PATH and CMAKE_BUILD_TYPE
								gc_message(SECTION "Useful CMake variables")
								gc_message(VARIABLE CMAKE_PREFIX_PATH)
								set_dynamic_option(CMAKE_BUILD_TYPE     # making CMAKE_BUILD_TYPE an option restricts it to Release and Debug
									DEFAULT ${CMAKE_BUILD_TYPE}
									OPTIONS "Release" "Debug"
									LOG CMAKE_VAR_LOG
								)
								dump_log(CMAKE_VAR_LOG)
							
								# Get the run directory
								gc_message(SECTION "Run directory setup")
								set(RUNDIR_DEFAULT "..")
								set_dynamic_default(RUNDIR DEFAULT "${RUNDIR_DEFAULT}"
									LOG RUNDIR_LOG
									IS_DIRECTORY
								)
								dump_log(RUNDIR_LOG)
								message(STATUS "Bootstrapping ${RUNDIR}")
								get_filename_component(RUNDIR "${RUNDIR}" ABSOLUTE) # Make RUNDIR an absolute path
							
								# Configure the GEOS-Chem build for GCHP or GC-Classic
								if(EXISTS ${RUNDIR}/input.geos)
									file(STRINGS ${RUNDIR}/input.geos GCHP REGEX ": *gchp_*")
								elseif(EXISTS ${RUNDIR}/getRunInfo)
									set(GCHP FALSE) # getRunInfo is only in GC-Classic run direcotries
								else()
									message(FATAL_ERROR "Your run directory doesn't have an input.geos or getRunInfo! Set RUNDIR to a valid run directory.")
								endif()
								if(GCHP)
									add_subdirectory(GCHP)
								else()
									# Configure for GCClassic
									include(GC-ConfigureClassic)
									configureGCClassic()
								endif()
							
								# Use the default compiler options
								include(GC-DefaultCompilerOptions)
							endif()
							
							# Add all the subdirectories. Each subdirectory specifies how it should be built.
							add_subdirectory(KPP)
							add_subdirectory(Headers)
							add_subdirectory(GeosUtil)
							add_subdirectory(NcdfUtil)
							add_subdirectory(History)
							add_subdirectory(ObsPack)
							add_subdirectory(APM)
							add_subdirectory(HEMCO)
							add_subdirectory(ISORROPIA)
							add_subdirectory(GeosRad)
							add_subdirectory(GTMM)
							add_subdirectory(GeosCore)
							
							# Write BaseTarget's configuration to a file
							get_target_property(BT_DEFINITIONS  BaseTarget INTERFACE_COMPILE_DEFINITIONS)
							get_target_property(BT_OPTIONS      BaseTarget INTERFACE_COMPILE_OPTIONS)
							get_target_property(BT_LIBRARIES    BaseTarget INTERFACE_LINK_LIBRARIES)
							get_target_property(BT_INCLUDES     BaseTarget INTERFACE_INCLUDE_DIRECTORIES)
							file(WRITE ${CMAKE_BINARY_DIR}/BaseTarget.txt
								"# This file shows the BaseTarget's configuration.\n"
								"\n"
								"BaseTarget::INTERFACE_COMPILE_DEFINITIONS:${BT_DEFINITIONS}\n"
								"BaseTarget::INTERFACE_COMPILE_OPTIONS:${BT_OPTIONS}\n"
								"BaseTarget::INTERFACE_LINK_LIBRARIES:${BT_LIBRARIES}\n"
								"BaseTarget::INTERFACE_INCLUDE_DIRECTORIES:${BT_INCLUDES}\n"
								"CMAKE_Fortran_FLAGS_RELEASE:${CMAKE_Fortran_FLAGS_RELEASE}\n"
								"CMAKE_Fortran_FLAGS_DEBUG:${CMAKE_Fortran_FLAGS_DEBUG}\n"
								"CMAKE_Fortran_FLAGS:${CMAKE_Fortran_FLAGS}\n\n"
							)									
						</code></pre>
					</section>
					<section>
						<div style="text-align: left;">
							<h3 style="margin: 0;">geos-chem/CMakeLists.txt</h3>
							<h5 style="margin: 0">Contents of CMakeScripts/</h5>
							<small style="width: 400px"><pre><code class="nohighlight" data-trim data-noescape>
								<strong>geos-chem/</strong>
								├── APM/
								├── bin/
								├── <strong>CMakeScripts/</strong>
								│   ├── <strong>FindNetCDF.cmake</strong>
								│   ├── GC-ConfigureClassic.cmake
								│   ├── GC-ConfigureForClassicRunDirectory.cmake
								│   ├── GC-DefaultCompilerOptions.cmake
								│   └── <strong>GC-Helpers.cmake</strong>
								├── doc/
								├── GeosCore/
								├── GeosRad/
								├── GeosUtil/
								├── GTMM/
								├── Headers/
								├── help/
								├── HEMCO/
								├── History/
								├── ISORROPIA/
								├── KPP/
								├── lib/
								├── mod/
								├── NcdfUtil/
								├── ObsPack/
								├── PKUCPL/
								├── AUTHORS.txt
								├── CMakeLists.txt
								├── LICENSE.txt
								├── Makefile
								├── Makefile_header.mk
								├── README.md
								└── REVISIONS
							</code></pre></small>
						</div>
					</section>
				</section>
				<section data-transition="none-in none-out">
					<section>
						<div style="text-align: left;">
							<h3 style="margin: 0;">GEOS-Chem's CMakeLists</h3>
							<h5 style="margin: 0">Configuring BaseTarget</h5>
							<hr>
							<ol>
								<li style="opacity: 0.5;">Set up the project
									<ul>
										<li>Declare the project</li>
										<li>Set policies</li>
										<li>Import helper functions</li>
										<li>Create <code>BaseTarget</code></li>
										<li>Set basic <code>BaseTarget</code> properties (e.g. module directory)</li>
									</ul>
								</li>
								<li>Configure <code>BaseTarget</code>
									<ul>
										<li>Find the run directory</li>
										<li>Call <code>${RUNDIR}/getRunInfo</code></li>
										<li>Set compiler definitions and options</li>
									</ul>
								<li style="opacity: 0.5;">Add subdirectories</li>
							</ol>
						</div>
					</section>
					<section>
						<h3 style="margin: 0;">geos-chem/CMakeLists.txt</h3>
						<hr>
						<pre><code class="cmake" data-trim data-noescape data-line-numbers="69-98">
							cmake_minimum_required(VERSION 3.5)
							project(GEOS_Chem VERSION 12.4.0 LANGUAGES Fortran)
							
							# Set policies
							cmake_policy(SET CMP0054 NEW)
							cmake_policy(SET CMP0057 NEW)
							if(POLICY CMP0074)
								cmake_policy(SET CMP0074 NEW)
							endif()
							if(POLICY CMP0079)
								cmake_policy(SET CMP0079 NEW)
							endif()
							
							# Add CMakeScripts/ to the module path and import helper functions
							list(INSERT CMAKE_MODULE_PATH 0 ${CMAKE_SOURCE_DIR}/CMakeScripts)
							include(GC-Helpers)
							
							# Declare the BaseTarget. All GEOS-Chem targets depend on BaseTarget.
							# This is used to control the compiler options and definitions for GEOS-Chem
							# targets (via inheritance). 
							add_library(BaseTarget INTERFACE)
							
							# Put all of GEOS-Chem's mod files in a subdirectory of the build directory called mod
							set(CMAKE_Fortran_MODULE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/mod)
							target_include_directories(BaseTarget 
								INTERFACE ${CMAKE_CURRENT_BINARY_DIR}/mod
							)
							
							# Link NetCDF-F to BaseTarget
							find_package(NetCDF REQUIRED)
							target_link_libraries(BaseTarget INTERFACE NetCDF-F)
							
							# Use the NC_HAS_COMPRESSION definition if nf_def_var_deflate is in netcdf.inc
							if(EXISTS ${NETCDF_F77_INCLUDE_DIR}/netcdf.inc)
								file(READ ${NETCDF_F77_INCLUDE_DIR}/netcdf.inc NCINC)
								if("${NCINC}" MATCHES ".*nf_def_var_deflate.*")
									target_compile_definitions(BaseTarget INTERFACE "NC_HAS_COMPRESSION")
								endif()
							endif()
							
							# Print a description of the source code repo's version
							get_repo_version(GC_REPO_VERSION ${CMAKE_SOURCE_DIR})
							message(STATUS "GEOS-Chem version: ${GC_REPO_VERSION}")
							
							if(NOT GC_EXTERNAL_CONFIG)
								# This conditional block configures the GEOS-Chem build for GEOS-Chem 
								# Classic. As mentioned above, it sets GCCLASSIC_EXE_TARGETS, RRTMG, GTMM
								# TOMAS, MECH, and GCHP, and it configures the BaseTarget.
							
								# Set CMAKE_BUILD_TYPE to Release by default
								if(NOT CMAKE_BUILD_TYPE)
									set(CMAKE_BUILD_TYPE "Release" 
										CACHE STRING
										"Choose the type of build, options are: Debug Release."
										FORCE
									)
								endif()
								
								# Display CMAKE_PREFIX_PATH and CMAKE_BUILD_TYPE
								gc_message(SECTION "Useful CMake variables")
								gc_message(VARIABLE CMAKE_PREFIX_PATH)
								set_dynamic_option(CMAKE_BUILD_TYPE     # making CMAKE_BUILD_TYPE an option restricts it to Release and Debug
									DEFAULT ${CMAKE_BUILD_TYPE}
									OPTIONS "Release" "Debug"
									LOG CMAKE_VAR_LOG
								)
								dump_log(CMAKE_VAR_LOG)
							
								# Get the run directory
								gc_message(SECTION "Run directory setup")
								set(RUNDIR_DEFAULT "..")
								set_dynamic_default(RUNDIR DEFAULT "${RUNDIR_DEFAULT}"
									LOG RUNDIR_LOG
									IS_DIRECTORY
								)
								dump_log(RUNDIR_LOG)
								message(STATUS "Bootstrapping ${RUNDIR}")
								get_filename_component(RUNDIR "${RUNDIR}" ABSOLUTE) # Make RUNDIR an absolute path
							
								# Configure the GEOS-Chem build for GCHP or GC-Classic
								if(EXISTS ${RUNDIR}/input.geos)
									file(STRINGS ${RUNDIR}/input.geos GCHP REGEX ": *gchp_*")
								elseif(EXISTS ${RUNDIR}/getRunInfo)
									set(GCHP FALSE) # getRunInfo is only in GC-Classic run direcotries
								else()
									message(FATAL_ERROR "Your run directory doesn't have an input.geos or getRunInfo! Set RUNDIR to a valid run directory.")
								endif()
								if(GCHP)
									add_subdirectory(GCHP)
								else()
									# Configure for GCClassic
									include(GC-ConfigureClassic)
									configureGCClassic()
								endif()
							
								# Use the default compiler options
								include(GC-DefaultCompilerOptions)
							endif()
							
							# Add all the subdirectories. Each subdirectory specifies how it should be built.
							add_subdirectory(KPP)
							add_subdirectory(Headers)
							add_subdirectory(GeosUtil)
							add_subdirectory(NcdfUtil)
							add_subdirectory(History)
							add_subdirectory(ObsPack)
							add_subdirectory(APM)
							add_subdirectory(HEMCO)
							add_subdirectory(ISORROPIA)
							add_subdirectory(GeosRad)
							add_subdirectory(GTMM)
							add_subdirectory(GeosCore)
							
							# Write BaseTarget's configuration to a file
							get_target_property(BT_DEFINITIONS  BaseTarget INTERFACE_COMPILE_DEFINITIONS)
							get_target_property(BT_OPTIONS      BaseTarget INTERFACE_COMPILE_OPTIONS)
							get_target_property(BT_LIBRARIES    BaseTarget INTERFACE_LINK_LIBRARIES)
							get_target_property(BT_INCLUDES     BaseTarget INTERFACE_INCLUDE_DIRECTORIES)
							file(WRITE ${CMAKE_BINARY_DIR}/BaseTarget.txt
								"# This file shows the BaseTarget's configuration.\n"
								"\n"
								"BaseTarget::INTERFACE_COMPILE_DEFINITIONS:${BT_DEFINITIONS}\n"
								"BaseTarget::INTERFACE_COMPILE_OPTIONS:${BT_OPTIONS}\n"
								"BaseTarget::INTERFACE_LINK_LIBRARIES:${BT_LIBRARIES}\n"
								"BaseTarget::INTERFACE_INCLUDE_DIRECTORIES:${BT_INCLUDES}\n"
								"CMAKE_Fortran_FLAGS_RELEASE:${CMAKE_Fortran_FLAGS_RELEASE}\n"
								"CMAKE_Fortran_FLAGS_DEBUG:${CMAKE_Fortran_FLAGS_DEBUG}\n"
								"CMAKE_Fortran_FLAGS:${CMAKE_Fortran_FLAGS}\n\n"
							)									
						</code></pre>
					</section>
					<section>
						<div style="text-align: left;">
							<h3 style="margin: 0;">geos-chem/CMakeLists.txt</h3>
							<h5 style="margin: 0">Contents of CMakeScripts/</h5>
							<small style="width: 400px"><pre><code class="nohighlight" data-trim data-noescape>
								<strong>geos-chem/</strong>
								├── APM/
								├── bin/
								├── <strong>CMakeScripts/</strong>
								│   ├── FindNetCDF.cmake
								│   ├── <strong>GC-ConfigureClassic.cmake</strong>
								│   ├── <strong>GC-ConfigureForClassicRunDirectory.cmake</strong>
								│   ├── <strong>GC-DefaultCompilerOptions.cmake</strong>
								│   └── GC-Helpers.cmake
								├── doc/
								├── GeosCore/
								├── GeosRad/
								├── GeosUtil/
								├── GTMM/
								├── Headers/
								├── help/
								├── HEMCO/
								├── History/
								├── ISORROPIA/
								├── KPP/
								├── lib/
								├── mod/
								├── NcdfUtil/
								├── ObsPack/
								├── PKUCPL/
								├── AUTHORS.txt
								├── CMakeLists.txt
								├── LICENSE.txt
								├── Makefile
								├── Makefile_header.mk
								├── README.md
								└── REVISIONS
							</code></pre></small>
						</div>
					</section>
				</section>
				<section data-transition="none-in none-out">
					<section>
						<div style="text-align: left;">
							<h3 style="margin: 0;">GEOS-Chem's CMakeLists</h3>
							<h5 style="margin: 0">Adding our subdirectories BaseTarget</h5>
							<hr>
							<ol>
								<li style="opacity: 0.5;">Set up the project
									<ul>
										<li>Declare the project</li>
										<li>Set policies</li>
										<li>Import helper functions</li>
										<li>Create <code>BaseTarget</code></li>
										<li>Set basic <code>BaseTarget</code> properties (e.g. module directory)</li>
									</ul>
								</li>
								<li style="opacity: 0.5;">Configure <code>BaseTarget</code>
									<ul>
										<li>Find the run directory</li>
										<li>Call <code>${RUNDIR}/getRunInfo</code></li>
										<li>Set compiler definitions and options</li>
									</ul>
								<li>Add subdirectories</li>
							</ol>
						</div>
					</section>
					<section>
						<h3 style="margin: 0;">geos-chem/CMakeLists.txt</h3>
						<hr>
						<pre><code class="cmake" data-trim data-noescape data-line-numbers="100-112">
							cmake_minimum_required(VERSION 3.5)
							project(GEOS_Chem VERSION 12.4.0 LANGUAGES Fortran)
							
							# Set policies
							cmake_policy(SET CMP0054 NEW)
							cmake_policy(SET CMP0057 NEW)
							if(POLICY CMP0074)
								cmake_policy(SET CMP0074 NEW)
							endif()
							if(POLICY CMP0079)
								cmake_policy(SET CMP0079 NEW)
							endif()
							
							# Add CMakeScripts/ to the module path and import helper functions
							list(INSERT CMAKE_MODULE_PATH 0 ${CMAKE_SOURCE_DIR}/CMakeScripts)
							include(GC-Helpers)
							
							# Declare the BaseTarget. All GEOS-Chem targets depend on BaseTarget.
							# This is used to control the compiler options and definitions for GEOS-Chem
							# targets (via inheritance). 
							add_library(BaseTarget INTERFACE)
							
							# Put all of GEOS-Chem's mod files in a subdirectory of the build directory called mod
							set(CMAKE_Fortran_MODULE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/mod)
							target_include_directories(BaseTarget 
								INTERFACE ${CMAKE_CURRENT_BINARY_DIR}/mod
							)
							
							# Link NetCDF-F to BaseTarget
							find_package(NetCDF REQUIRED)
							target_link_libraries(BaseTarget INTERFACE NetCDF-F)
							
							# Use the NC_HAS_COMPRESSION definition if nf_def_var_deflate is in netcdf.inc
							if(EXISTS ${NETCDF_F77_INCLUDE_DIR}/netcdf.inc)
								file(READ ${NETCDF_F77_INCLUDE_DIR}/netcdf.inc NCINC)
								if("${NCINC}" MATCHES ".*nf_def_var_deflate.*")
									target_compile_definitions(BaseTarget INTERFACE "NC_HAS_COMPRESSION")
								endif()
							endif()
							
							# Print a description of the source code repo's version
							get_repo_version(GC_REPO_VERSION ${CMAKE_SOURCE_DIR})
							message(STATUS "GEOS-Chem version: ${GC_REPO_VERSION}")
							
							if(NOT GC_EXTERNAL_CONFIG)
								# This conditional block configures the GEOS-Chem build for GEOS-Chem 
								# Classic. As mentioned above, it sets GCCLASSIC_EXE_TARGETS, RRTMG, GTMM
								# TOMAS, MECH, and GCHP, and it configures the BaseTarget.
							
								# Set CMAKE_BUILD_TYPE to Release by default
								if(NOT CMAKE_BUILD_TYPE)
									set(CMAKE_BUILD_TYPE "Release" 
										CACHE STRING
										"Choose the type of build, options are: Debug Release."
										FORCE
									)
								endif()
								
								# Display CMAKE_PREFIX_PATH and CMAKE_BUILD_TYPE
								gc_message(SECTION "Useful CMake variables")
								gc_message(VARIABLE CMAKE_PREFIX_PATH)
								set_dynamic_option(CMAKE_BUILD_TYPE     # making CMAKE_BUILD_TYPE an option restricts it to Release and Debug
									DEFAULT ${CMAKE_BUILD_TYPE}
									OPTIONS "Release" "Debug"
									LOG CMAKE_VAR_LOG
								)
								dump_log(CMAKE_VAR_LOG)
							
								# Get the run directory
								gc_message(SECTION "Run directory setup")
								set(RUNDIR_DEFAULT "..")
								set_dynamic_default(RUNDIR DEFAULT "${RUNDIR_DEFAULT}"
									LOG RUNDIR_LOG
									IS_DIRECTORY
								)
								dump_log(RUNDIR_LOG)
								message(STATUS "Bootstrapping ${RUNDIR}")
								get_filename_component(RUNDIR "${RUNDIR}" ABSOLUTE) # Make RUNDIR an absolute path
							
								# Configure the GEOS-Chem build for GCHP or GC-Classic
								if(EXISTS ${RUNDIR}/input.geos)
									file(STRINGS ${RUNDIR}/input.geos GCHP REGEX ": *gchp_*")
								elseif(EXISTS ${RUNDIR}/getRunInfo)
									set(GCHP FALSE) # getRunInfo is only in GC-Classic run direcotries
								else()
									message(FATAL_ERROR "Your run directory doesn't have an input.geos or getRunInfo! Set RUNDIR to a valid run directory.")
								endif()
								if(GCHP)
									add_subdirectory(GCHP)
								else()
									# Configure for GCClassic
									include(GC-ConfigureClassic)
									configureGCClassic()
								endif()
							
								# Use the default compiler options
								include(GC-DefaultCompilerOptions)
							endif()
							
							# Add all the subdirectories. Each subdirectory specifies how it should be built.
							add_subdirectory(KPP)
							add_subdirectory(Headers)
							add_subdirectory(GeosUtil)
							add_subdirectory(NcdfUtil)
							add_subdirectory(History)
							add_subdirectory(ObsPack)
							add_subdirectory(APM)
							add_subdirectory(HEMCO)
							add_subdirectory(ISORROPIA)
							add_subdirectory(GeosRad)
							add_subdirectory(GTMM)
							add_subdirectory(GeosCore)
							
							# Write BaseTarget's configuration to a file
							get_target_property(BT_DEFINITIONS  BaseTarget INTERFACE_COMPILE_DEFINITIONS)
							get_target_property(BT_OPTIONS      BaseTarget INTERFACE_COMPILE_OPTIONS)
							get_target_property(BT_LIBRARIES    BaseTarget INTERFACE_LINK_LIBRARIES)
							get_target_property(BT_INCLUDES     BaseTarget INTERFACE_INCLUDE_DIRECTORIES)
							file(WRITE ${CMAKE_BINARY_DIR}/BaseTarget.txt
								"# This file shows the BaseTarget's configuration.\n"
								"\n"
								"BaseTarget::INTERFACE_COMPILE_DEFINITIONS:${BT_DEFINITIONS}\n"
								"BaseTarget::INTERFACE_COMPILE_OPTIONS:${BT_OPTIONS}\n"
								"BaseTarget::INTERFACE_LINK_LIBRARIES:${BT_LIBRARIES}\n"
								"BaseTarget::INTERFACE_INCLUDE_DIRECTORIES:${BT_INCLUDES}\n"
								"CMAKE_Fortran_FLAGS_RELEASE:${CMAKE_Fortran_FLAGS_RELEASE}\n"
								"CMAKE_Fortran_FLAGS_DEBUG:${CMAKE_Fortran_FLAGS_DEBUG}\n"
								"CMAKE_Fortran_FLAGS:${CMAKE_Fortran_FLAGS}\n\n"
							)									
						</code></pre>
					</section>
				</section>
				<section>
					<section>
						<h2>How are subdirectory targets included?</h2>
					</section>
					<section>
						<div style="text-align: left;">
							<h3 style="margin: 0;">How are subdirectory targets included?</h3>
							<h5 style="margin: 0">Using History/ as an example</h5>
							<small style="width: 400px"><pre><code class="nohighlight" data-trim data-noescape>
								<strong>geos-chem/</strong>
								├── APM/
								├── bin/
								├── CMakeScripts/
								├── doc/
								├── GeosCore/
								├── GeosRad/
								├── GeosUtil/
								├── GTMM/
								├── Headers/
								├── help/
								├── HEMCO/
								├── <strong>History/</strong>
								│   ├── CMakeLists.txt
								│   ├── histcontainer_mod.F90
								│   ├── histitem_mod.F90
								│   ├── history_mod.F90
								│   ├── history_netcdf_mod.F90
								│   ├── history_util_mod.F90
								│   ├── Makefile
								│   ├── metahistcontainer_mod.F90
								│   └── metahistitem_mod.F90
								├── ISORROPIA/
								├── KPP/
								├── lib/
								├── mod/
								├── NcdfUtil/
								├── ObsPack/
								├── PKUCPL/
								├── AUTHORS.txt
								├── CMakeLists.txt
								├── LICENSE.txt
								├── Makefile
								├── Makefile_header.mk
								├── README.md
								└── REVISIONS
							</code></pre></small>
						</div>
					</section>
					<section>
						<h3 style="margin: 0;">Recall</h3>
						<hr>
						<img class="plain" data-src="images/GC.svg" style="height: 500px; width: 500px;">
					</section>
					<section>
						<div style="text-align: left;">
							<h3 style="margin: 0;">Create the <code>History</code> target</h3>
							<h5 style="margin: 0;">geos-chem/History/CMakeLists.txt</code></h5>
							<hr>
							<div style="position: relative;">
								<div>
									<pre><code class="cmake" data-trim data-noescape data-line-numbers>
										add_library(History STATIC EXCLUDE_FROM_ALL
											histcontainer_mod.F90
											histitem_mod.F90
											history_mod.F90
											history_netcdf_mod.F90
											history_util_mod.F90
											metahistcontainer_mod.F90
											metahistitem_mod.F90
										)
										target_link_libraries(History
											PUBLIC GeosUtil2
										)
									</code></pre>
								</div>
								<div class="file-tree"> 
									<small style="position: absolute; top: 0; right: 0; background-color: white;"><code>
										<strong>geos-chem/</strong><br>
										├── APM/<br>
										├── bin/<br>
										├── CMakeScripts/<br>
										├── doc/<br>
										├── GeosCore/<br>
										├── GeosRad/<br>
										├── GeosUtil/<br>
										├── GTMM/<br>
										├── Headers/<br>
										├── help/<br>
										├── HEMCO/<br>
										├── <strong>History/</strong><br>
										│   ├── <strong>CMakeLists.txt</strong><br>
										│   ├── histcontainer_mod.F90<br>
										│   ├── histitem_mod.F90<br>
										│   ├── history_mod.F90<br>
										│   ├── history_netcdf_mod.F90<br>
										│   ├── history_util_mod.F90<br>
										│   ├── Makefile<br>
										│   ├── metahistcontainer_mod.F90<br>
										│   └── metahistitem_mod.F90<br>
										├── ISORROPIA/<br>
										├── KPP/<br>
										├── lib/<br>
										├── mod/<br>
										├── NcdfUtil/<br>
										├── ObsPack/<br>
										├── PKUCPL/<br>
										├── AUTHORS.txt<br>
										├── CMakeLists.txt<br>
										├── LICENSE.txt<br>
										├── Makefile<br>
										├── Makefile_header.mk<br>
										├── README.md<br>
										└── REVISIONS<br>
									</code></small>
								</div>
							</div>
					</section>
					<section>
						<div style="text-align: left;">
							<h3 style="margin: 0;">Link <code>History</code> into <code>GeosCore</code></h3>
							<h5 style="margin: 0;">Snippet from geos-chem/GeosCore/CMakeLists.txt</code></h5>
							<hr>
							<div style="position: relative;">
								<div>
									<pre><code class="cmake" data-trim data-noescape>
										target_link_libraries(GeosCore
											PUBLIC
												Transport ObsPack HCOI History
			
												$<$< STREQUAL:${MECH},SOA_SVPOA>:KPP_SOA_SVPOA>
												$<$< STREQUAL:${MECH},Standard>:KPP_Standard>
												$<$< STREQUAL:${MECH},Tropchem>:KPP_Tropchem>
			
												$<$< BOOL:${APM}>:APM>
												$<$< BOOL:${RRTMG}>:GeosRad>
												$<$< BOOL:${GTMM}>:Hg>

												Isorropia
										)	
									</code></pre>
								</div>
								<div class="file-tree"> 
									<small style="position: absolute; top: 0; right: 0; background-color: white;"><code>
										<strong>geos-chem/</strong><br>
										├── APM/<br>
										├── bin/<br>
										├── CMakeScripts/<br>
										├── doc/<br>
										├── <strong>GeosCore/</strong><br>
										│   ├── aero_drydep.F<br>
										│   ├── ...<br>
										│   ├── <strong>CMakeLists.txt</strong><br>
										│   ├── ...<br>
										│   └── YuIMN_Code.F<br>
										├── GeosRad/<br>
										├── GeosUtil/<br>
										├── GTMM/<br>
										├── Headers/<br>
										├── help/<br>
										├── HEMCO/<br>
										├── History/<br>
										├── ISORROPIA/<br>
										├── KPP/<br>
										├── lib/<br>
										├── mod/<br>
										├── NcdfUtil/<br>
										├── ObsPack/<br>
										├── PKUCPL/<br>
										├── AUTHORS.txt<br>
										├── CMakeLists.txt<br>
										├── LICENSE.txt<br>
										├── Makefile<br>
										├── Makefile_header.mk<br>
										├── README.md<br>
										└── REVISIONS<br>
									</code></small>
								</div>
							</div>
					</section>
				</section>
				<section>
					<h2>Questions?</h2>
					<hr>
					<img class="plain" data-src="images/GC.svg" style="height: 500px; width: 500px;">
				</section>
			</div>
		</div>

		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
				]
			});
		</script>
	</body>
</html>
